---
layout:     post
published:  true
title:      "中间人攻击"
subtitle:   "计算机网络笔记"
date:       2020-12-29 19:00:00
author:     "Manual"
header-img: "img/post-bg-alitrip.jpg"
catalog: true
tags:
    - 计算机网络
---

> 本文介绍了什么是中间人攻击和解决方法

## 含义

请求或响应在传输途中，遭攻击者拦截并篡改内容的攻击称为中间人攻击(MITM)，即指攻击者与通讯的两端分别创建独立的联系，并交换其所收到的数据，使通讯的两端认为他们正在通过一个私密的连接与对方直接对话，但事实上整个会话都被攻击者完全控制。

## 分类

**HTTP协议**内容是明文传输的，没有经过任何加密，而这些明文数据会经过WiFi、路由器、运营商、机房等多个物理设备节点，如果在这中间任意一个节点被监听，传输的内容就会完全暴露，即被中间人攻击。

**ARP协议**的基本功能就是通过目标设备的IP地址，查询目标设备的MAC地址，以保证通信的进行。ARP攻击也是一种中间人攻击，他通过伪造IP地址和MAC地址实现ARP欺骗，能够在网络中产生大量的ARP通信量使网络阻塞，攻击者只要持续不断的发出伪造的ARP响应包就能更改目标主机ARP缓存中的IP-MAC条目，造成网络中断，但是ARP攻击仅能在以太网进行，无法对外网进行攻击。

**针对SSL的中间人攻击方式**主要有两类，分别是SSL劫持攻击和SSL剥离攻击。SSL劫持攻击即SSL证书欺骗攻击，攻击者为了获得HTTPS传输的明文数据，需要先将自己接入到客户端和目标网站之间，在传输过程中伪造服务器的证书，将服务器的公钥替换成自己的公钥，这样，中间人就可以得到明文传输带Key1、Key2和Pre-Master-Key，从而窃取客户端和服务端的通信数据。SSL剥离攻击也需要将攻击者设置为中间人，之后见HTTPS范文替换为HTTP返回给浏览器，而中间人和服务器之间仍然保持HTTPS服务器，由于HTTP是明文传输的，所以中间人可以获取客户端和服务器传输数据。

## 攻击过程

HTTPS协议被中间人攻击的过程如图1所示，中间人截取客户端发送给服务器的请求，然后伪装成客户端与服务器进行通信，将服务器返回给客户端的内容发送给客户端，伪装成服务器与客户端进行通信，通过这样的手段，便可以获取客户端和服务器之间通信的所有内容。使用中间人攻击手段，必须要让客户端信任中间人的证书，如果客户端不信任，则这种攻击手段也无法发挥作用。

![中间人攻击](/img/img-post/中间人攻击.png)

1. 客户端发送请求到服务端，请求被中间人截获

2. 服务器向客户端发送公钥

3. 中间人截获公钥，保留在自己手上，然后自己生成一个【伪造的】公钥，发给客户端

4. 客户端收到伪造的公钥后，生成加密hash值发给服务器

5. 中间人获得加密hash值，用自己的私钥解密获得真秘钥，同时生成假的加密hash值，发给服务器

6. 服务器用私钥解密获得假密钥，然后加密数据传输给客户端

## 解决方法

使用HTTPS协议，SSL/TLS协议加密传输，数字签名和数字证书（CA）。

HTTPS协议其实就是将HTTP协议的数据包再通过SSL/TLS加密后传输，SSL协议位于TCP/IP协议与各种应用协议之间，是一种国际标准的加密及身份认证通信协议。HTTPS协议为了兼顾性能和安全性，使用了**非对称加密+对称加密**的方案，为了保证公钥传输中不被篡改，又使用了非对称加密的数字签名功能，借助CA机构和系统根证书的机制保证了HTTPS证书的公信力。

### SSL协议特点

1. SSL协议可用于保护正常运行与TCP之上的任何应用协议，如HTTP、FTP、SMTP或Telent的通信，最常见的是用户SSL来保护HTTP通信

2. SSL协议的优点在于它是应用层协议无关的，高层的应用协议能透明的建立于SSL协议之上

3. SSL协议的应用层协议之前就完成加密算法、通信密钥的协商以及服务器的认证工作，在此之后应用层协议所传送的数据都会被加密，从而保证通信的安全性

4. SSL协议使用通信双方的客户证书以及CA根证书，允许客户/服务器应用以一种不能被偷听的方式通信，在通信双方建立起了一条安全的、可信任的通信通道

5. 该协议使用密钥对传送数据加密，许多网站都是通过这种协议从客户端接收信用卡编号等保密信息，常用于交易过程

### 对称加密与非对称加密

对称加密是指有一个密钥，用它可以对一段明文加密，加密之后也只能用这个密钥来解密得到明文。

非对称加密有两个密钥，一个是公钥，另一个是私钥。一般来说，公钥用来加密，这时密文只能用私钥才能解开。

非对称加解密耗时要远大于对称加解密，我们才最终选用了上文介绍到非对称加密+对称加密的方案

### CA颁发机构

为了解决**客户端无法确认收到的公钥是不是真的是服务端发来的**，服务端在使用HTTPS前，去经过认证的CA机构申请颁发一份**数字证书**，数字证书里包含有证书持有者、证书有效期、公钥等信息，服务端将证书发送给客户端，客户端校验证书身份和要访问的网站身份确实一致后再进行后续的加密操作。

私钥除了**解密**外的真正用途其实还有一个，就是**数字签名**，其实就是一种防伪技术，只要有人篡改了证书，那么数字签名必然校验失败。

1. CA机构拥有自己的一对公钥和私钥
2. CA机构在颁发证书时对证书明文信息进行哈希
3. 将哈希值用私钥进行**加签**，得到数字签名

**签名过程**

1. 明文数据和数字签名组成证书，传递给客户端。
2. 客户端得到证书，分解成明文部分Text和数字签名Sig1
3. 用CA机构的公钥进行**解签**，得到Sig2（由于CA机构是一种公信身份，因此在系统或浏览器中会内置CA机构的证书和公钥信息）
4. 用证书里声明的哈希算法对明文Text部分进行哈希得到H
5. 当自己计算得到的哈希值H与**解签**后的Sig2**相等**，表示证书可信，**没有被篡改**

### HTTPS实现原理

HTTPS的加解密流程(非对称加密+对称加密)

1. 用户在浏览器发起HTTPS请求（如 https://www.mogu.com/），默认使用服务端的443端口进行连接；
2. HTTPS需要使用一套**CA数字证书**，证书内会附带一个**公钥Pub**，而与之对应的**私钥Private**保留在服务端不公开；
3. 服务端收到请求，返回配置好的包含**公钥Pub**的证书给客户端；
4. 客户端收到**证书**，校验合法性，主要包括是否在有效期内、证书的域名与请求的域名是否匹配，上一级证书是否有效（递归判断，直到判断到系统内置或浏览器配置好的根证书），如果不通过，则显示HTTPS警告信息，如果通过则继续；
5. 客户端生成一个用于对称加密的**随机Key**，并用证书内的**公钥Pub**进行加密，发送给服务端；
6. 服务端收到**随机Key**的密文，使用与**公钥Pub**配对的**私钥Private**进行解密，得到客户端真正想发送的**随机Key**；
7. 服务端使用客户端发送过来的**随机Key**对要传输的HTTP数据进行对称加密，将密文返回客户端；
8. 客户端使用**随机Key**对称解密密文，得到HTTP数据明文；
9. 后续HTTPS请求使用之前交换好的**随机Key**进行对称加解密。

![https](/img/img-post/https.png)

