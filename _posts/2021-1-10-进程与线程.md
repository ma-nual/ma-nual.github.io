---
layout:     post
published:  true
title:      "进程与线程"
subtitle:   "操作系统笔记"
date:       2021-1-10 19:00:00
author:     "Manual"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
    - 操作系统
---

> 本文介绍了进程与线程的相关知识

## 含义

### 进程

进程是**资源分配**的基本单位。

**进程组成：**PCB(进程描述信息、控制管理信息、资源分配信息等)、程序段(程序中代码)、数据段 (运行过程中产生的各种数据)

进程控制块 (Process Control Block, PCB) 描述进程的基本信息和运行状态，所谓的创建进程和撤销进程，都是指对 PCB 的操作。

### 线程

线程是**独立调度**的基本单位。

一个进程中可以有多个线程，它们共享进程资源。

## 进程和线程的区别与联系（补充应用）

### 区别

**I 拥有资源**

进程占有资源，但是线程不占有，线程可以访问隶属进程的资源。

进程所维护的是程序所包含的资源(**静态资源**)， 如：**地址空间，打开的文件句柄集，文件系统状态， 信号处理handler**等;

线程所维护的运行相关的资源(**动态资源**)，如：**运行栈，调度相关的控制信息，待处理的信号集等**; 

**II 调度**

线程是独立调度的基本单位，在同一进程中，线程的切换不会引起进程切换，从一个进程中的线程切换到另一个进程中的线程时，会引起进程切换。进程切换开销大，由切换页全局目录和切换内核态堆栈和硬件上下文（一组寄存器值）两步组成，涉及当前执行进程 CPU 环境的保存及新调度进程 CPU 环境的设置，线程切换只是把寄存器值保存到内核堆栈里，再加载被调度线程的寄存器值。

**III 系统开销**

线程创建销毁只需要处理PC值，状态码，通用寄存器值，线程栈及栈指针即可；进程创建和销毁系统都要为之分配或回收资源，如内存空间、I/O 设备等，需要重新分配及销毁task_struct结构，所付出的开销远大于创建或撤销线程时的开销。

**IV 通信方面**

线程间可以通过直接读写同一进程中的数据段（如全局变量）进行通信，但是进程通信需要借助 IPC，如管道，信号，消息队列，共享内存，套接字等通信机制，需要进程同步和互斥手段的辅助，以保证数据的一致性。

**V 健壮性**

线程、进程之间都可以并发，多进程程序比多线程程序更健壮，进程之间不会相互影响，因为进程有自己独立的地址空间；而一个线程崩溃会导致进程崩溃，从而影响同一个进程里面的其他线程。

### 联系

线程是存在进程的内部，一个进程中可以有多个线程，一个线程只能存在一个进程中。

## 进程间通信

**1.管道**

无名管道（内存文件）：管道是一种半双工的通信方式，数据只能单向交替流动，而且只能在具有亲缘关系的进程之间使用，进程的亲缘关系通常是指父子进程或者兄弟进程关系，管道的实质是一个内核缓冲区，进程以先进先出的方式从缓冲区存取数据。管道是通过调用 pipe 函数创建的，fd[0] 用于读，fd[1] 用于写。管道是最容易实现的。

```c
#include <unistd.h>
int pipe(int fd[2]);
```

![管道](/img/img-post/管道.png)

**2.FIFO**

有名管道（FIFO文件，借助文件系统）：有名管道也是半双工的通信方式，但是允许在没有亲缘关系的进程之间使用。

```c
#include <sys/stat.h>
int mkfifo(const char *path, mode_t mode);
int mkfifoat(int fd, const char *path, mode_t mode);
```

**3.消息队列**

消息队列是一个消息的链表，存放在内核中并由消息队列标识符标识。消息队列克服了信号传递信息少、管道只能承载无格式字节流以及缓冲区大小受限等缺点。相比于 FIFO，消息队列可以独立于读写进程存在，从而避免了 FIFO 中同步管道的打开和关闭时可能产生的困难。避免了 FIFO 的同步阻塞问题，不需要进程自己提供同步方法。读进程可以根据消息类型有选择地接收消息，而不像 FIFO 那样只能默认地接收。

**4.信号**

用于通知接收进程某个事件已经发生，信号可以在任何时候发送给某一进程，而无须知道该进程的状态。如果该进程并未处于执行状态，则该信号就由内核保存起来，直到该进程恢复执行并传递给他为止。如果一个信号被进程设置为阻塞，则该信号的传递被延迟，直到其阻塞被取消时才被传递给进程。信号是开销最小的。

**5.信号量**

信号量是一个计数器，可以用来控制多个进程对共享资源的访问。信号量只有等待和发送两种操作，等待(P(sv))就是将其值减一或者挂起进程，发送(V(sv))就是将其值加一或者将进程恢复运行。它常作为一种锁机制，实现进程、线程的对临界区的同步及互斥访问。

**6.共享内存**

共享内存就是映射一段能被其他进程所访问的内存，这段共享内存由一个进程创建，但多个进程都可以访问。因为数据不需要在进程之间复制，共享内存是最快的IPC方式，缺点是没有提供同步机制，需要使用锁等其他机制进行同步，它往往与信号量配合使用来实现进程间的同步和通信。多个进程可以将同一个文件映射到它们的地址空间从而实现共享内存，另外 XSI 共享内存不是使用文件，而是使用内存的匿名段。

**7.套接字**

适用于不同机器间进程通信，在本地也可作为两个进程通信的方式。

## 线程怎么创建，怎么运行



## join和detach区别



## 线程同步



## 多核线程调度



## 中断上下文和进程上下文

